# mysso
æ¨¡æ‹Ÿæ·˜å®å•ç‚¹ç™»å½•SSO

ä¸»è¦è¿ç”¨åŠ è½½é™æ€èµ„æºæµè§ˆå™¨ä¸è¿›è¡ŒåŒæºç­–ç•¥é™åˆ¶çš„åŸç†ï¼ŒåæœŸæœ‰æ—¶é—´ä¼šè¿›ä¸€æ­¥å®Œå–„è¿™ä¸ªé¡¹ç›®ã€‚
ç°åœ¨è¿™ä¸ªé¡¹ç›®æ˜¯ç®€å•çš„æ¼”ç¤ºé€»è¾‘ï¼Œè¯æ˜è¿™ç§æ–¹æ¡ˆçš„å¯è¡Œæ€§ã€‚

# æ·˜å®ã€å¤©çŒ«çš„å•ç‚¹ç™»å½•-SSO
ä»Šå¤©æ¢³ç†äº†ä¸‹å•ç‚¹ç™»å½•ï¼Œè¿™ä¸ªå¾ˆæ—©ä¹‹å‰æœ‰æ¥è§¦è¿‡ã€‚å•ç‚¹ç™»å½•çš„æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œä¸åŒçš„æ–¹æ¡ˆä¹Ÿæœ‰ä¸åŒçš„ç”¨æˆ·ä½“éªŒï¼Œæœ€ç»ˆå®ç°çš„æ˜¯é›†ä¸­ç®¡ç†ç™»å½•ï¼Œç™»å½•çŠ¶æ€åœ¨æ‰€æœ‰å…è®¸çš„ç³»ç»Ÿä¸­é€šç”¨ã€‚
æœ€ç®€å•çš„æ˜¯æ‰€æœ‰ç³»ç»Ÿéƒ½åœ¨åŒæº<åè®®://åŸŸå{å­åŸŸå}:ç«¯å£>ï¼Œç›´æ¥é€šè¿‡cookieå°±å¯ä»¥è§£å†³ã€‚éåŒæºçš„å¸¸è§æ–¹æ¡ˆæœ‰ç”¨åœ°å€æ åŠ tokenå®ç°ï¼Œæœ‰è¿‡é€šè¿‡åŸŸåè½¬å‘æ˜ å°„è§£å†³çš„ã€ä¹Ÿæœ‰é€šè¿‡éƒ¨ç½²å¤šå¥—ç³»ç»Ÿè§£å†³çš„ğŸ˜‚ã€‚
å…´èµ·ä¹‹ä¸‹æƒ³çœ‹ä¸‹é˜¿é‡Œå·´å·´ä»–ä»¬SSOæ˜¯æ€ä¹ˆç©çš„ã€‚

## åˆ†ææ·˜å®å’Œå¤©çŒ«SSOé€»è¾‘
æ·˜å®åœ°å€ï¼šhttps://www.taobao.com/
å¤©çŒ«åœ°å€ï¼šhttps://www.tmall.com/

<!-- more -->

1. æŸ¥çœ‹æ·˜å®åŸŸåä¸‹çš„æ‰€æœ‰cookieä¿¡æ¯ä»¥åŠæ•°æ®è¯·æ±‚ä¿¡æ¯ï¼š
![cookie](http://xieahui.com/uploads/sso/æ·˜å®cookieä¿¡æ¯.jpeg)

2. æŸ¥çœ‹æ·˜å®æ§åˆ¶å°è­¦å‘Šä¿¡æ¯
![è­¦å‘Š](http://xieahui.com/uploads/sso/æ·˜å®è­¦å‘Šä¿¡æ¯.jpeg)

3. å…¶ä¸­çš„ä¸€ä¸ªè¯·æ±‚è¿æ¥
![è¯·æ±‚è¿æ¥](http://xieahui.com/uploads/sso/å…¶ä¸­çš„ä¸€ä¸ªè¯·æ±‚è¿æ¥.jpeg)

3. æŸ¥çœ‹æ·˜å®æ§åˆ¶å°æ¥å£è¯·æ±‚ä¿¡æ¯
![ç½‘ç»œè¯·æ±‚ä¿¡æ¯](http://xieahui.com/uploads/sso/æ·˜å®ç½‘ç»œè¯·æ±‚.jpeg)

çœ‹è¿™ä¸ªåº”è¯¥å®¹æ˜“æƒ³èµ·æ¥æ·˜å®æ˜¯æ€ä¹ˆç©çš„SSOäº†ã€‚æ²¡é”™ï¼Œä»–æ˜¯åˆ©ç”¨çš„æµè§ˆå™¨åŒæºç­–ç•¥åŠ è½½é™æ€èµ„æºæ—¶çš„éåŒæºé™åˆ¶çš„é—®é¢˜ã€‚ä¸‹é¢æ¨¡ä»¿è€…ç©ä¸€ä¸‹ï¼Œç¡®è®¤ä¸‹æ˜¯ä¸æ˜¯è¿™ä¹ˆå›äº‹ã€‚

## éªŒè¯çŒœæµ‹æ˜¯å¦æ­£ç¡®ï¼š
ä¸‰ä¸ªé¡¹ç›®åˆ†åˆ«æ˜¯ï¼šmysso<çœŸæ­£çš„ç™»å½•å…¥å£>ã€myservice1<ä½¿ç”¨å•ç‚¹ç™»å½•çš„æœåŠ¡1>ã€myservice2<ä½¿ç”¨å•ç‚¹ç™»å½•çš„æœåŠ¡2>ï¼Œæˆ‘ç”¨mavenç»§æ‰¿å…³ç³»æŠŠä»–ä»¬æ”¾åˆ°ä¸€ä¸ªé¡¹ç›®é‡Œäº†ã€‚
1. é¦–å…ˆç¡®å®šä¸‰ä¸ªæµ‹è¯•ä½¿ç”¨çš„åŸŸåï¼š
mysso.com : ssoç™»å½•çš„é¡¹ç›®ï¼› myservice1.com : ä½¿ç”¨ssoæœåŠ¡çš„ç³»ç»Ÿ1ï¼› myservice2.com : ä½¿ç”¨ssoæœåŠ¡çš„ç³»ç»Ÿ2ï¼›

### é…ç½®hosts
2. é…ç½®hosts
```javascript
127.0.0.1 mysso.com  myservice1.com myservice2.com
```

### é…ç½®nginx
3. é…ç½®nginxåå‘ä»£ç†
3.1. mysso.com.conf:
```javascript
server {
        listen       80;
        server_name  mysso.com;

        #charset koi8-r;

        access_log  logs/mysso.access.log  main;
        error_log logs/mysso.error.log;
        
        #root /Users/brucexie/Documents/work/myspace/retail/retail-wap;
        
        location / {
                    add_header 'Access-Control-Allow-Origin' "$http_origin";
                    add_header 'Access-Control-Allow-Credentials' 'true';
                    add_header 'Access-Control-Allow-Methods' 'GET, POST';
                    add_header 'Access-Control-Allow-Headers' 'X-Requested-With';
                    proxy_pass         http://localhost:8068;
                    proxy_set_header   Host             $host;
                    proxy_set_header   X-Real-IP        $remote_addr;
                    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
    
            }	
    
            error_page   500 502 503 504  /50x.html;
            location = /50x.html {
                root   html;
            }

    }
```

3.2. myservice1.com.conf
```javascript
server {
        listen       80;
        server_name  myservice1.com;

        #charset koi8-r;

        access_log  logs/myservice1.access.log  main;
        error_log logs/myservice1.error.log;
        
        #root /Users/brucexie/Documents/work/myspace/retail/retail-wap;
        
        location / {
                    add_header 'Access-Control-Allow-Origin' "$http_origin";
                    add_header 'Access-Control-Allow-Credentials' 'true';
                    add_header 'Access-Control-Allow-Methods' 'GET, POST';
                    add_header 'Access-Control-Allow-Headers' 'X-Requested-With';
                    proxy_pass         http://localhost:8066;
                    proxy_set_header   Host             $host;
                    proxy_set_header   X-Real-IP        $remote_addr;
                    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
    
            }	
    
            error_page   500 502 503 504  /50x.html;
            location = /50x.html {
                root   html;
            }

    }
```

3.3. myservice2.com.conf
```javascript
server {
        listen       80;
        server_name  myservice2.com;

        #charset koi8-r;

        access_log  logs/myservice2.access.log  main;
        error_log logs/myservice2.error.log;
        
        #root /Users/brucexie/Documents/work/myspace/retail/retail-wap;
        
        location / {
                    add_header 'Access-Control-Allow-Origin' "$http_origin";
                    add_header 'Access-Control-Allow-Credentials' 'true';
                    add_header 'Access-Control-Allow-Methods' 'GET, POST';
                    add_header 'Access-Control-Allow-Headers' 'X-Requested-With';
                    proxy_pass         http://localhost:8067;
                    proxy_set_header   Host             $host;
                    proxy_set_header   X-Real-IP        $remote_addr;
                    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
    
            }	
    
            error_page   500 502 503 504  /50x.html;
            location = /50x.html {
                root   html;
            }

    }
```

### æ­å»ºæµ‹è¯•ä»£ç 
å·¥ç¨‹ç›®å½•ç»“æ„ï¼š
![ç›®å½•ç»“æ„](http://xieahui.com/uploads/sso/ä»£ç ç›®å½•ç»“æ„.jpeg)

è€ƒè™‘äº†ä¸‹ï¼Œä»£ç å¤ªå¤šã€‚é€‰æ‹©ä¸€äº›æœ‰æ„ä¹‰çš„è´´å‡ºæ¥ï¼Œåé¢å°†æ•´ä¸ªä»£ç éƒ½ä¸Šä¼ åˆ°githubä¸Šã€‚è¿™ä¸ªé¡¹ç›®ä»£ç æœ¬èº«æ˜¯ä¸ºäº†éªŒè¯é˜¿é‡Œssoçš„ä¸€ç§æ€è·¯ï¼Œå°†æ¥æœ‰æ—¶é—´çš„è¯å†æ¥æ•´ç†ä¸€ä¸‹ã€‚
myssoä¸­çš„LoginController.java
```javascript
package com.sso.mysso.ssoservice;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * Created by xiehui1956(@)gmail.com on 2020/3/13
 */
@Controller
public class LoginController {

    final String LC = "loginCookie", MG = "msg", TK = "abc";

    @GetMapping("/login")
    public String login(HttpServletRequest request, HttpServletResponse response, Model model
            , @RequestParam(required = false, defaultValue = "1") String name
            , @RequestParam(required = false, defaultValue = "2") String pwd) {

        Cookie[] cookies = request.getCookies();
        if (null != cookies)
            for (Cookie cookie : cookies) {
                if (cookie.getName().equals(LC) && cookie.getValue().equals("121")) {
                    model.addAttribute(MG, "already-login");
                    model.addAttribute(TK, "login-success");
                    return "/index";

                }
            }

        if (name.equals(pwd)) {
            Cookie cookie = new Cookie(LC, "121");
            cookie.setPath("/");
            cookie.setDomain(".mysso.com");
            response.addCookie(cookie);
            model.addAttribute(MG, "first-login-success");
            model.addAttribute(TK, "login-success");
            return "/index";
        }
        return "/index";
    }

}
```

myssoä¸­çš„index.html
```javascript
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>main</title>
    <script src="https://cdn.bootcss.com/jquery/1.10.2/jquery.js"></script>
    <script type="application/javascript">
        let script = document.createElement('script');
        script.setAttribute('src', 'http://myservice1.com/login?token=[[${abc}]]');
        document.getElementsByTagName('head')[0].appendChild(script);

        script = document.createElement('script');
        script.setAttribute('src', 'http://myservice2.com/login?token=[[${abc}]]');
        document.getElementsByTagName('head')[0].appendChild(script);
    </script>
</head>
<body>
sso-[[${msg}]]
<br>
<span th:text="${msg}"></span>
</body>
</html>
```
ç”±äºåªæ˜¯æµ‹è¯•ï¼Œè¿™é‡Œè¯·æ±‚åœ°å€å†™æ­»äº†ã€‚

myservice1ä¸­çš„LoginController.java
```javascript
package com.sso.mysso.myservice1;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * Created by xiehui1956(@)gmail.com on 2020/3/13
 */
@RestController
public class LoginController {

    final String LC = "loginCookie";

    @GetMapping("/login")
    public String login(HttpServletRequest request, HttpServletResponse response, String token) throws IOException {

        Cookie[] cookies = request.getCookies();
        if (null != cookies)
            for (Cookie cookie : cookies) {
                if (cookie.getName().equals(LC) && cookie.getValue().equals("121")) {
                    return "already-login";
                }
            }

        if ("login-success".equals(token)) {
            Cookie cookie = new Cookie(LC, "121");
            cookie.setPath("/");
            cookie.setDomain(".myservice1.com");
            response.addCookie(cookie);
            return "first-login-success";
        }

        response.sendRedirect("http://mysso.com/login");
        return "error";
    }

}

```

myservice2ä¸­çš„LoginController.java
```javascript
package com.sso.mysso.myservice2;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * Created by xiehui1956(@)gmail.com on 2020/3/13
 */
@RestController
public class LoginController {

    final String LC = "loginCookie";

    @GetMapping("/login")
    public String login(HttpServletRequest request, HttpServletResponse response, String token) throws IOException {

        Cookie[] cookies = request.getCookies();
        if (null != cookies)
            for (Cookie cookie : cookies) {
                if (cookie.getName().equals(LC) && cookie.getValue().equals("121")) {
                    return "already-login";
                }
            }

        if ("login-success".equals(token)) {
            Cookie cookie = new Cookie(LC, "121");
            cookie.setPath("/");
            cookie.setDomain(".myservice2.com");
            response.addCookie(cookie);
            return "first-login-success";
        }

        response.sendRedirect("http://mysso.com/login");
        return "error";
    }
    
}

```

### è·‘ä¸€ä¸‹çœ‹ç»“æœ
ssoç™»å½•åçš„ç»“æœ
![sso](http://xieahui.com/uploads/sso/æµ‹è¯•ç”¨ä¾‹sso.jpeg)

ssoå¼‚å¸¸è­¦å‘Šä¿¡æ¯ï¼Œå‘ç°è¿™ä¸ªå¼‚å¸¸å’Œæ·˜å®æ§åˆ¶å°åŒ…çš„å¼‚å¸¸æœ‰äº›ç›¸ä¼¼
![å¼‚å¸¸è­¦å‘Š](http://xieahui.com/uploads/sso/ssoå¼‚å¸¸ä¿¡æ¯.jpeg)

service1æœåŠ¡å·²ç»ç™»å½•äº†
![service1](http://xieahui.com/uploads/sso/service1.jpeg)

service2æœåŠ¡å·²ç»ç™»å½•äº†
![service2](http://xieahui.com/uploads/sso/service2.jpeg)

é€€å‡ºç™»å½•ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚

æ€»ç»“ï¼šåœ¨ä¸€ä¸ªæœåŠ¡ä¸Šé€šè¿‡åŠ è½½èµ„æºçš„å½¢å¼å»è°ƒç”¨å…¶ä»–æœåŠ¡çš„ç™»å½•æ¥å£ï¼Œå¤„ç†è¯·æ±‚æ¥å£çš„æœåŠ¡æ ¹æ®æ ‡è¯†å»å†™å…¥å®¢æˆ·ç«¯cookieã€‚
å®é™…çš„é¡¹ç›®ä¸­è¦è€ƒè™‘çš„é—®é¢˜è¿œä¸æ­¢è¿™äº›ï¼Œåƒå®‰å…¨ç­–ç•¥ã€åŸ‹ç‚¹åˆ†æè¿™ä¸ªdemoä¸­éƒ½æ²¡æœ‰æ¶‰åŠã€‚ä»…éªŒè¯äº†ä¸€ç§å‹å¥½çš„SSOç™»å½•å®ç°æ–¹å¼ï¼Œä¸ä¼šåƒæœ‰äº›é¡¹ç›®ä¸€æ ·èµ°åˆ°å“ªé‡Œå±è‚¡åé¢éƒ½è·Ÿç€ä¸€ä¸ªtokenã€‚